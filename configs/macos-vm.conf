# macOS Sonoma/Sequoia/Tahoe VM Configuration
# ──────────────────────────────────────────────────────────────────────────────
# References:
#   OpenCore ISO:       https://github.com/LongQT-sea/OpenCore-ISO
#   macOS ISO builder:  https://github.com/LongQT-sea/macos-iso-builder
#   Intel iGPU passthru: https://github.com/LongQT-sea/intel-igpu-passthru
#   OSX-KVM:            https://github.com/kholia/OSX-KVM
#   OSX-KVM notes:      https://github.com/kholia/OSX-KVM/blob/master/notes.md
# ──────────────────────────────────────────────────────────────────────────────

# ── Identity ──────────────────────────────────────────────────────────────────
VM_NAME="macos-sequoia"
VM_HOSTNAME="mac-mini"
VM_USER="admin"

# ── Machine / Firmware ────────────────────────────────────────────────────────
# q35 is recommended by OpenCore-ISO for modern macOS
# Use pc (i440fx) ONLY for Legacy Mode iGPU passthrough (GVT-d PF, NOT SR-IOV VF)
VM_MACHINE_TYPE="q35"
VM_FIRMWARE="uefi"
# CPU model options (pick ONE):
#   Skylake-Client-v4  — recommended by OpenCore-ISO for macOS 10.11–26 (best perf)
#   Haswell-noTSX      — recommended by OSX-KVM for Sonoma+ (wider compat)
#   Penryn             — ONLY for macOS ≤ Ventura (kernel panic on Sonoma+)
# Note: host-passthrough is ~30% slower single-core than named models (OpenCore-ISO benchmarks)
# Note: macOS requires core count that is a power of 2 (1/2/4/8/16)
#   For 6 cores: use 2 cores × 3 sockets. For 12: 4 cores × 3 sockets.
VM_CPU_MODEL="Skylake-Client-v4,vendor=GenuineIntel,+invtsc,+aes,+xsave,+avx2"
VM_VCPUS="4"
VM_RAM_MB="8192"

# ── Storage ───────────────────────────────────────────────────────────────────
VM_DISK_GB="128"
VM_DISK_PATH="/var/lib/libvirt/images/macos-sequoia.qcow2"
VM_DISK_FORMAT="qcow2"
# VirtIO  — better performance (macOS 10.15+)
# SATA    — supports TRIM/Discard, wider compat (macOS 10.4+)
VM_DISK_BUS="virtio"
VM_DISK_CACHE="none"

# ── OS ────────────────────────────────────────────────────────────────────────
VM_OS_VARIANT="generic"
# OpenCore bootloader ISO (from LongQT-sea/OpenCore-ISO releases)
VM_ISO_PATH="/home/sandriaas/iso/LongQT-OpenCore.iso"
# macOS installer ISO (from LongQT-sea/macos-iso-builder or fetch-macOS-v2.py + dmg2img)
VM_EXTRA_ISO="/home/sandriaas/iso/macOS-Sequoia.iso"
VM_BOOT_ORDER="cdrom,hd"
VM_AUTOINSTALL="no"

# ── Network ───────────────────────────────────────────────────────────────────
VM_NET_TYPE="network"
VM_NET_SOURCE="default"
# VirtIO   — macOS 11–26 (Big Sur+)
# vmxnet3  — macOS 10.11–10.15
# e1000    — macOS 10.4–10.10
VM_NET_MODEL="virtio"
VM_STATIC_IP="192.168.122.160/24"
VM_GATEWAY="192.168.122.1"
VM_DNS="1.1.1.1,8.8.8.8"
VM_SSH_PORT="22"

# ── Display / Console ─────────────────────────────────────────────────────────
# VNC for initial install; switch to none after GPU passthrough
VM_GRAPHICS="vnc"
# vmware-svga — best resolution control in macOS via OpenCore config.plist
#   (set Resolution in OpenCore/config.plist → UEFI → Output → Resolution)
#   see: OSX-KVM notes.md "Change resolution in OpenCore"
# virtio     — alternative, may need extra setup
VM_VIDEO="vmware"
VM_CONSOLE="pty,target_type=serial"

# ── Features ──────────────────────────────────────────────────────────────────
VM_FEATURES="acpi,apic"
VM_CLOCK="utc"
VM_AUTOSTART="no"
# macOS: disable memory ballooning (required — OpenCore-ISO docs)
VM_BALLOON="no"

# ── Shared Storage ────────────────────────────────────────────────────────────
SHARED_DIR="/home/sandriaas/server-data"
SHARED_TAG="hostshare"

# ── GPU / SR-IOV Passthrough ──────────────────────────────────────────────────
# macOS does NOT support Intel iGPU SR-IOV Virtual Functions — no i915 VF drivers exist.
# For GPU acceleration, options are:
#   1. Full PF passthrough (GVT-d Legacy Mode): requires machine=pc (i440fx),
#      x-igd-lpc=on, and host loses display. See: intel-igpu-passthru/macOS_README.md
#      Alder Lake iGPU (8086:46a6) needs WhateverGreen device-id spoofing.
#   2. Dedicated AMD dGPU passthrough: RX 6600 recommended (Dortania GPU guide).
#      See: OSX-KVM notes.md "GPU passthrough notes"
#   3. No GPU passthrough: software rendering only (fine for headless/SSH use).
GPU_PASSTHROUGH="no"
GPU_GEN="12"
GPU_PCI_ID=""
GPU_VF_COUNT="0"
GPU_DRIVER="none"
GPU_ROM_PATH=""
GPU_IGD_LPC="no"

# ── Cloudflare Tunnel ─────────────────────────────────────────────────────────
VM_TUNNEL_NAME="macos-ssh"
VM_TUNNEL_HOST=""

# ── Post-Install Notes ───────────────────────────────────────────────────────
# 1. Boot from OpenCore ISO, format disk in Disk Utility (APFS), install macOS
# 2. After install: copy EFI folder from OpenCore ISO to macOS EFI partition
#    (use Mount_EFI.command on Desktop)
# 3. For iCloud/iMessage: generate unique SMBIOS with GenSMBIOS
#    (see: https://dortania.github.io/OpenCore-Post-Install/universal/iservices.html)
# 4. macOS 15+ needs VMHide.kext for iServices
#    (see: https://github.com/Carnations-Botanica/VMHide)
# 5. Enable Remote Login (SSH) via System Preferences → Sharing
# 6. Disable Energy Saver + Screen Saver for VM stability
# 7. Resolution: edit OpenCore config.plist UEFI→Output→Resolution (e.g. 1920x1080)
#    then match in OVMF menu: Device Manager → OVMF Platform Configuration
